name: Security Analysis

on:
  push:
    branches: [ "main", "master", "dev", "test" ]
  pull_request:
  schedule:
    - cron: "0 3 * * 1" # Executa toda segunda-feira às 03h da manhã
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:

  # ============================================================
  # 1) CODEQL — Análise Avançada de Segurança
  # ============================================================
  codeql:
    name: CodeQL Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java

      - name: Compilar projeto (necessário para CodeQL)
        run: ./gradlew build --no-daemon

      - name: Executar análise CodeQL
        uses: github/codeql-action/analyze@v3


  # ============================================================
  # 2) OWASP DEPENDENCY CHECK — Escaneia dependências Gradle
  # ============================================================
  dependency-check:
    name: OWASP Dependency-Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Baixar OWASP Dependency-Check
        run: |
          wget https://github.com/jeremylong/DependencyCheck/releases/download/v10.0.3/dependency-check-10.0.3-release.zip
          unzip dependency-check-10.0.3-release.zip -d depcheck

      - name: Executar scanner
        run: |
          ./depcheck/dependency-check/bin/dependency-check.sh \
            --project "MeuProjetoJava" \
            --scan . \
            --format "HTML" \
            --out reports

      - name: Upload do relatório OWASP
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: reports


  # ============================================================
  # 3) SPOTBUGS — Análise Estática Java
  # ============================================================
  spotbugs:
    name: SpotBugs Static Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Dar permissão ao Gradle
        run: chmod +x ./gradlew

      - name: Rodar SpotBugs
        run: ./gradlew spotbugsMain spotbugsTest --no-daemon

      - name: Upload relatórios SpotBugs
        uses: actions/upload-artifact@v4
        with:
          name: spotbugs-reports
          path: build/reports/spotbugs


  # ============================================================
  # 4) SEMGREP — Política de segurança customizada (opcional)
  # ============================================================
  semgrep:
    name: Semgrep Scan
    runs-on: ubuntu-latest

    container:
      image: returntocorp/semgrep

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Rodar Semgrep
        run: semgrep scan --config auto --error --json --output report.json

      - name: Upload resultado do Semgrep
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: report.json
