name: TP5 - CI/CD Full Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  actions: read
  id-token: write    # necessÃ¡rio para OIDC

env:
  JAVA_TOOL_OPTIONS: "-Dfile.encoding=UTF-8"
  GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx1024m"

concurrency:
  group: "tp5-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      jar-path: ${{ steps.set.outputs.jar }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper/
          key: gradle-cache-${{ runner.os }}-${{ hashFiles('**/*.gradle*','**/gradle-wrapper.properties') }}
          restore-keys: gradle-cache-${{ runner.os }}-

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Build (assemble)
        run: ./gradlew clean assemble --no-daemon

      - name: Set output jar
        id: set
        run: |
          echo "::set-output name=jar::$(ls build/libs/*.jar | head -n1)"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-libs
          path: build/libs/*.jar

  unit-and-ui-tests:
    name: Unit & Selenium Tests (CI)
    needs: build
    runs-on: ubuntu-latest
    env:
      CI: true
      HEADLESS: "true"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Restore Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper/
          key: gradle-cache-${{ runner.os }}-${{ hashFiles('**/*.gradle*','**/gradle-wrapper.properties') }}

      - name: Grant execute
        run: chmod +x gradlew

      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Start Xvfb
        run: |
          sudo apt-get install -y xvfb
          nohup Xvfb :99 -screen 0 1920x1080x24 &

      - name: Run tests + jacoco verification
        run: ./gradlew clean check jacocoTestReport --no-daemon

      - name: Upload junit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-results
          path: build/test-results/test

      - name: Upload jacoco
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: build/reports/jacoco

      - name: Upload app logs (if produced)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-logs
          path: logs/**

  code-quality:
    name: Code Quality
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run SpotBugs (Gradle)
        run: ./gradlew spotbugsMain spotbugsTest || true

      - name: Run PMD (Gradle)
        run: ./gradlew pmdMain pmdTest || true

      - name: Upload quality reports
        uses: actions/upload-artifact@v4
        with:
          name: quality-reports
          path: build/reports/

  codeql:
    name: CodeQL SAST
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: java
      - name: Autobuild
        uses: github/codeql-action/autobuild@v2
      - name: Run CodeQL
        uses: github/codeql-action/analyze@v2

  dependency-scan:
    name: Dependency Scan (OWASP)
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run OWASP DependencyCheck
        uses: jeremylong/DependencyCheck@v6
        with:
          project: "TP5"
          format: 'ALL'

  dast-owasp-zap:
    name: DAST (OWASP ZAP)
    needs: unit-and-ui-tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Start ZAP baseline scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          target: 'http://localhost:7000' # altere para a URL de deploy se for DAST externo
        env:
          TZ: 'America/Sao_Paulo'

  package:
    name: Package
    needs: [unit-and-ui-tests, code-quality]
    runs-on: ubuntu-latest
    outputs:
      package-path: ${{ steps.pkg.outputs.zip }}
    steps:
      - uses: actions/checkout@v4
      - name: Build jar
        run: ./gradlew clean assemble --no-daemon
      - name: Create releases dir
        run: mkdir -p build/releases
      - name: Zip package
        run: |
          zip -r build/releases/app-${{ github.run_number }}.zip build/libs/
      - id: pkg
        run: echo "::set-output name=zip::build/releases/app-${{ github.run_number }}.zip"

  deploy-dev:
    name: Deploy - dev
    needs: package
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: actions/checkout@v4

      - name: Configure cloud credentials (OIDC example)
        # Exemplo para AWS. Troque para provider da sua escolha.
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: 'us-east-1'

      - name: Upload artifact to dev storage (example)
        run: |
          aws s3 cp build/releases/app-${{ github.run_number }}.zip s3://my-bucket/dev/ || true

      - name: Set deploy url
        run: echo "DEPLOY_URL=https://app-dev.example.com" >> $GITHUB_ENV

  post-deploy-tests:
    name: Post-deploy Selenium Tests
    needs: [deploy-dev]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK & Chrome
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Install Chrome
        run: sudo apt-get update && sudo apt-get install -y google-chrome-stable

      - name: Run post-deploy Selenium tests
        env:
          BASE_URL: ${{ env.DEPLOY_URL }}
          CI: true
        run: |
          ./gradlew test -DbaseUrl=${{ env.DEPLOY_URL }} --no-daemon

      - name: Upload post-deploy logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: post-deploy-logs
          path: logs/post-deploy/**

  create-release:
    name: Create Release
    needs: package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Create tag
        run: |
          TAG="artifact-ci-${{ github.run_id }}"
          echo "TAG=$TAG" >> $GITHUB_ENV
          git tag $TAG
          git push origin $TAG
      - name: Create Release and attach package
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          name: ${{ env.TAG }}
          files: ${{ needs.package.outputs.package-path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-and-summary:
    name: Notify & Summary
    needs: [unit-and-ui-tests, codeql, dast-owasp-zap, create-release]
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary markdown
        run: |
          cat > summary.md <<'MD'
          # Pipeline summary
          - Build: ${{ needs.build.result }}
          - Tests: ${{ needs.unit-and-ui-tests.result }}
          - SAST(CodeQL): ${{ needs.codeql.result }}
          - DAST(ZAP): ${{ needs.dast-owasp-zap.result }}
          - Release: ${{ needs.create-release.result }}
          MD
      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-summary
          path: summary.md
      - name: Post summary as PR comment (if PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: summary.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
